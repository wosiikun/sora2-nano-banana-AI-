# 文件关系和工作流程说明

## 📁 文件概述

### 1. **sora_api_clean.py** - API封装层
**作用：** 封装多个Sora视频生成API，提供统一的调用接口

**主要组件：**
- **API配置管理** (`API_CONFIG`)：存储各平台的API密钥和地址
  - `yunwusora`: 云雾平台API配置
  - `yuansora`: 自定义API配置
  - `yunwujuese`: 角色创建API配置
  - `upload_servers`: 中转服务器配置（图片和视频上传）

- **错误处理规则** (`ERROR_RULES`)：定义各平台的错误处理策略
  - 根据错误关键词自动切换平台
  - 例如：yuansora遇到"儿童"内容错误时切换到yunwusora

- **API类：**
  - `yunwusora`: 云雾平台视频生成类
  - `yuansora`: 自定义API视频生成类
  - `yunwujuese`: 角色创建类

**核心功能：**
- 支持文生视频和图生视频
- 自动上传文件到中转服务器
- 轮询任务状态直到完成
- 返回统一的响应格式：`{"success": bool, "video_url": str, "task_id": str, "error": str}`

---

### 2. **appapp.py** - Streamlit前端界面
**作用：** 提供用户交互界面，管理任务执行和结果显示

**主要功能：**
- **两种生成模式：**
  - 📝 文生视频：纯文本提示词生成视频
  - 🖼️ 图生视频：基于图片生成视频

- **两种执行模式：**
  - **串行模式**：只启动第一个API
  - **并行模式**：同时启动所有API（对比测试）

- **任务管理：**
  - 通过 `subprocess.Popen` 启动独立的 `worker.py` 进程
  - 每个任务有唯一的 `task_id`（格式：`{type}_{api}`）
  - 清空旧任务日志

- **实时日志显示：**
  - 读取 `logs.json` 文件
  - 显示任务状态（running/success/failed）
  - 显示视频预览和错误信息
  - 自动刷新（有运行中任务时每3秒刷新）

---

### 3. **worker.py** - 后台工作进程
**作用：** 独立运行的API调用脚本，执行实际的视频生成任务

**工作方式：**
- 通过命令行参数接收任务信息
- 参数格式：`python worker.py <task_id> <api_name> <prompt> <duration> <orientation> <style> <image_path>`

**执行流程：**
1. 解析命令行参数
2. 根据 `api_name` 选择对应的API类（yuansora 或 yunwusora）
3. 调用API的 `generate()` 方法
4. 将执行日志写入 `logs.json`
5. 将最终结果写入 `logs.json`

**日志格式：**
```json
{
  "task_id": {
    "logs": ["[时间] 日志信息"],
    "status": "running|success|failed",
    "result": {
      "success": true/false,
      "video_url": "视频URL",
      "task_id": "任务ID",
      "error": "错误信息"
    }
  }
}
```

---

## 🔄 完整工作流程

### 流程1：文生视频（串行模式）

```
用户操作
  ↓
appapp.py: 用户输入提示词、时长、方向、风格
  ↓
appapp.py: 点击"生成"按钮
  ↓
appapp.py: clear_task_logs("text") - 清空旧日志
  ↓
appapp.py: start_worker() - 启动worker.py进程
  ↓
worker.py: 接收参数 (task_id="text_yuansora", api_name="yuansora", ...)
  ↓
worker.py: write_log() - 写入开始日志到logs.json
  ↓
worker.py: 根据api_name创建API实例 (yuansora())
  ↓
worker.py: 调用 api.generate() - 调用sora_api_clean.py
  ↓
sora_api_clean.py: yuansora.generate()
  ├─ 构建multipart/form-data请求
  ├─ 上传图片到中转服务器（如果有）
  ├─ 发送POST请求到API
  ├─ 获取task_id
  └─ 轮询任务状态（每10秒查询一次，最多60次）
  ↓
sora_api_clean.py: 返回结果 {"success": true, "video_url": "...", "task_id": "..."}
  ↓
worker.py: write_result() - 写入结果到logs.json
  ↓
appapp.py: read_logs() - 读取logs.json
  ↓
appapp.py: 显示视频预览和状态
  ↓
appapp.py: 自动刷新（如果有运行中任务）
```

### 流程2：图生视频（并行模式）

```
用户操作
  ↓
appapp.py: 用户上传图片、输入提示词
  ↓
appapp.py: 保存图片到临时文件
  ↓
appapp.py: 并行启动多个worker进程
  ├─ worker.py (task_id="image_yuansora", ...)
  └─ worker.py (task_id="image_yunwusora", ...)
  ↓
多个worker.py同时运行
  ├─ worker1: 调用yuansora API
  └─ worker2: 调用yunwusora API
  ↓
每个worker独立写入logs.json
  ↓
appapp.py: 读取logs.json，显示所有任务的结果
  ↓
用户可以对比不同API的生成效果
```

---

## 🔗 文件之间的依赖关系

```
appapp.py (前端界面)
    │
    ├─→ subprocess.Popen() 启动
    │
    └─→ worker.py (后台进程)
            │
            ├─→ import sora_api_clean
            │
            └─→ sora_api_clean.py (API封装)
                    │
                    ├─→ yunwusora.generate()
                    ├─→ yuansora.generate()
                    └─→ yunwujuese.create()
```

**数据流：**
```
appapp.py ←─ logs.json ←─ worker.py ←─ sora_api_clean.py → API服务器
(显示)      (共享日志)    (写入日志)    (调用API)
```

---

## 🎯 核心设计特点

### 1. **进程隔离**
- `worker.py` 作为独立进程运行，避免阻塞Streamlit界面
- 即使worker崩溃，界面也不会受影响

### 2. **文件共享通信**
- 使用 `logs.json` 作为进程间通信媒介
- worker写入日志，appapp读取日志
- 简单可靠，无需复杂的进程间通信

### 3. **并行测试能力**
- 可以同时测试多个API平台
- 对比不同平台的生成效果和速度

### 4. **错误处理机制**
- `sora_api_clean.py` 中定义了错误处理规则
- 可以根据错误类型自动切换平台（虽然当前worker.py未使用）

### 5. **中转服务器支持**
- 自动上传图片/视频到中转服务器
- 如果上传失败，回退到使用本地路径

---

## 📊 数据格式

### logs.json 结构
```json
{
  "text_yuansora": {
    "logs": [
      "[14:30:15] 🚀 开始 yuansora",
      "[14:30:16] 📡 调用 yuansora API...",
      "[14:30:20] ✅ 生成成功"
    ],
    "status": "success",
    "result": {
      "success": true,
      "video_url": "https://...",
      "task_id": "xxx"
    }
  },
  "image_yunwusora": {
    "logs": [...],
    "status": "running",
    "result": null
  }
}
```

---

## 🔧 使用场景

1. **API测试**：快速测试不同平台的API效果
2. **性能对比**：并行模式可以对比不同API的生成速度
3. **容错测试**：测试API的错误处理能力
4. **批量生成**：可以同时生成多个视频

---

## 💡 改进建议

1. **错误自动切换**：当前worker.py未使用ERROR_RULES，可以添加自动切换逻辑
2. **任务队列**：可以添加任务队列管理，避免同时启动过多进程
3. **结果持久化**：可以将成功的结果保存到数据库或文件系统
4. **进度显示**：可以显示更详细的生成进度（当前只有日志）

---

*最后更新：2026-01-24*
